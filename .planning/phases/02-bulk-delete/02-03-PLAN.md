---
phase: 02-bulk-delete
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/parsers/entity-id-parser.ts
  - src/config/delete-types.ts
  - src/cli.ts
  - src/commands/delete.ts
autonomous: true
gap_closure: true
requirements: [DEL-01]

must_haves:
  truths:
    - "Parser reads Entity ID from the named 'Entity ID' column, not column index 0"
    - "Parser reads Space ID from the named 'Space ID' column and returns it alongside entity IDs"
    - "Parser rejects CSVs with multiple distinct Space IDs"
    - "--space CLI flag is optional (not required)"
    - "Delete command uses CSV-parsed spaceId for all API calls and reports"
    - "If --space flag provided and conflicts with CSV space, command exits with error"
  artifacts:
    - path: "src/parsers/entity-id-parser.ts"
      provides: "Named column parsing for Space ID and Entity ID, spaceId in return type"
      contains: "row['Entity ID']"
    - path: "src/config/delete-types.ts"
      provides: "DeleteOptions with optional space field"
      contains: "space?: string"
    - path: "src/cli.ts"
      provides: "Delete subcommand with optional --space flag"
      contains: ".option('-s, --space"
    - path: "src/commands/delete.ts"
      provides: "Delete handler using parsed spaceId from CSV"
      contains: "spaceId"
  key_links:
    - from: "src/parsers/entity-id-parser.ts"
      to: "src/commands/delete.ts"
      via: "spaceId field in EntityIdParseResult"
      pattern: "spaceId"
    - from: "src/commands/delete.ts"
      to: "src/api/geo-client.ts"
      via: "fetchEntityDetails(id, spaceId, network) using CSV-parsed spaceId"
      pattern: "fetchEntityDetails\\(.*spaceId"
---

<objective>
Fix CSV parser column ordering bug and make space ID sourced from CSV instead of CLI flag.

Purpose: UAT tests 2 and 4 are blockers -- parser reads column 0 (Space ID) as entity IDs instead of reading the named "Entity ID" column. The delete command hardcodes `options.space` from CLI when it should use CSV-parsed space. User decision: CSV is primary source for space ID, `--space` becomes optional override.

Output: Parser reads named columns, returns spaceId, enforces single space per CSV. Delete command and CLI updated to use CSV-parsed space.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bulk-delete/02-UAT.md
@.planning/debug/csv-parser-column-order.md
@.planning/phases/02-bulk-delete/02-02-SUMMARY.md
@src/parsers/entity-id-parser.ts
@src/commands/delete.ts
@src/cli.ts
@src/config/delete-types.ts
@src/api/geo-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix entity-id-parser to read named columns and return spaceId</name>
  <files>src/parsers/entity-id-parser.ts, src/config/delete-types.ts</files>
  <action>
**src/parsers/entity-id-parser.ts:**

1. Update `EntityIdParseResult` interface to add `spaceId: string` field:
```typescript
export interface EntityIdParseResult {
  ids: string[];
  spaceId: string;
  errors: string[];
}
```

2. Update the JSDoc to reflect the two-column CSV expectation: "Reads entity IDs from the 'Entity ID' column and space ID from the 'Space ID' column."

3. Replace the column-reading logic in the parsing loop. Currently line 54-55 does:
```typescript
const values = Object.values(row);
const raw = values[0];
```
Change to read named columns:
```typescript
const entityIdRaw = row['Entity ID'];
const spaceIdRaw = row['Space ID'];
```

4. Add a `spaceIds` Set to collect all space IDs from the CSV. For each row:
   - Read `row['Entity ID']` -- validate with isValidGeoId(), add to ids
   - Read `row['Space ID']` -- validate with isValidGeoId(), add to spaceIds Set
   - If either column is missing/empty on a row where the other has data, add error: `Row N: Missing Entity ID` or `Row N: Missing Space ID`
   - If Space ID is invalid format, add error: `Row N: "X" is not a valid space ID (expected 32-char hex string)`

5. After the loop, validate single space ID:
   - If `spaceIds.size === 0` and `ids.length > 0`, add error: "No Space ID found in CSV"
   - If `spaceIds.size > 1`, add error: `CSV contains multiple Space IDs: ${[...spaceIds].join(', ')}. Each CSV must target a single space.`
   - Extract the single spaceId: `const spaceId = [...spaceIds][0] ?? '';`

6. Return updated result: `{ ids, spaceId, errors }`

7. Handle the edge case where a row is completely blank (both columns empty/undefined) -- skip silently as before.

**src/config/delete-types.ts:**

Change `space: string` to `space?: string` on line 13 of the DeleteOptions interface. Update the comment from "Required --space flag" to "Optional --space flag (CSV is primary source)".
  </action>
  <verify>
    <automated>cd /Users/Vytautas/Documents/GitHub/spreadsheet-to-geo && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify that EntityIdParseResult has spaceId field and DeleteOptions.space is optional</manual>
  </verify>
  <done>
    - EntityIdParseResult interface has `spaceId: string` field
    - Parser reads `row['Entity ID']` and `row['Space ID']` by header name (not Object.values index)
    - Parser collects space IDs into Set and validates exactly 1 unique space ID
    - Parser returns spaceId alongside ids and errors
    - DeleteOptions.space is optional (string | undefined)
    - TypeScript compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI and delete command to use CSV-parsed spaceId</name>
  <files>src/cli.ts, src/commands/delete.ts</files>
  <action>
**src/cli.ts:**

1. Line 44: Change `.requiredOption('-s, --space <id>', 'Target space ID (32-char hex)')` to `.option('-s, --space <id>', 'Override space ID from CSV (32-char hex)')`.

2. Lines 50-56: In the action handler type annotation, change `space: string` to `space?: string` to match the now-optional field.

3. Lines 63-70: In the options object passed to `deleteCommand`, change `space: opts!.space` to `space: opts?.space` (optional chaining since space may be undefined).

**src/commands/delete.ts:**

After `parseEntityIds()` on line 148, destructure the new `spaceId` field:
```typescript
const { ids, spaceId: csvSpaceId, errors: parseErrors } = parseEntityIds(filePath, 'Sheet1');
```

Add space ID resolution logic right after the "No entity IDs found" check (after line 161). This resolves the final spaceId from CSV and optional flag:
```typescript
// Resolve space ID: CLI flag overrides CSV, but conflict = error
let spaceId: string;
if (options.space && csvSpaceId && options.space !== csvSpaceId) {
  logger.error(`Space ID mismatch: --space flag "${options.space}" differs from CSV Space ID column "${csvSpaceId}"`);
  process.exit(1);
}
if (options.space) {
  spaceId = options.space;
} else if (csvSpaceId) {
  spaceId = csvSpaceId;
} else {
  logger.error('No space ID found. Provide --space flag or include a "Space ID" column in the CSV.');
  process.exit(1);
}
```

Replace ALL 7 occurrences of `options.space` in the remaining function body with the resolved `spaceId` variable:

1. Line 130: `logger.keyValue('Space', options.space)` -> `logger.keyValue('Space', spaceId)` (NOTE: move this log line AFTER the space resolution block, since spaceId is not yet defined at line 130. Place it right after the resolution block.)
2. Line 174: `fetchEntityDetails(id, options.space, network)` -> `fetchEntityDetails(id, spaceId, network)`
3. Line 191: `logger.error(...in space ${options.space}:...)` -> `logger.error(...in space ${spaceId}:...)`
4. Line 222: `spaceId: options.space` in dry-run report -> `spaceId: spaceId`
5. Line 283: `spaceId: options.space` in metadata -> `spaceId: spaceId`
6. Line 323: `spaceId: options.space` in final report -> `spaceId: spaceId`

(The original line 130 `logger.keyValue('Space', options.space)` must move below the space resolution block since `spaceId` doesn't exist at that point in execution. Reorder the logging section so Space is logged after resolution.)
  </action>
  <verify>
    <automated>cd /Users/Vytautas/Documents/GitHub/spreadsheet-to-geo && npx tsc --noEmit 2>&1 | head -30 && echo "---" && npx tsx src/index.ts delete --help 2>&1 | head -20</automated>
    <manual>Verify --space is shown as optional (no "required" tag) in help output. Run `npx tsx src/index.ts delete "Geo delete template - Entities to delete.csv" --dry-run --network TESTNET` and confirm it reads entity ID 673736370ab644b28cd2ac34e5c18cfd (not the space ID) and uses space ad4bd3902613b19081fd65db609588ee from CSV.</manual>
  </verify>
  <done>
    - `--space` is optional in CLI help (not marked required)
    - Delete command resolves spaceId from CSV when --space not provided
    - Delete command errors on --space vs CSV mismatch
    - Delete command errors when neither --space nor CSV provides space ID
    - All 7 former `options.space` references use resolved `spaceId`
    - TypeScript compiles with no errors
    - Running delete with the user's CSV template parses entity ID 673736370ab644b28cd2ac34e5c18cfd (not space ID)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx tsx src/index.ts delete --help` shows --space as optional (not required)
3. `npx tsx src/index.ts delete "Geo delete template - Entities to delete.csv" --dry-run --network TESTNET` correctly parses entity ID 673736370ab644b28cd2ac34e5c18cfd and uses space ad4bd3902613b19081fd65db609588ee from CSV (resolves UAT tests 2 and 4)
4. No remaining references to `Object.values(row)[0]` in entity-id-parser.ts
5. No remaining references to `options.space` in delete.ts after the resolution block
</verification>

<success_criteria>
- UAT test 2 passes: Parser reads Entity ID from correct column and Space ID from Space ID column
- UAT test 4 passes: Delete command correctly parses entity IDs from user's CSV
- --space is optional CLI flag, CSV is primary source
- Single space per CSV enforced, mismatch with --space flag produces clear error
</success_criteria>

<output>
After completion, create `.planning/phases/02-bulk-delete/02-03-SUMMARY.md`
</output>
