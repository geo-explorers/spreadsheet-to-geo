---
phase: 03-bulk-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/cli-helpers.ts
  - src/commands/upsert.ts
  - src/config/types.ts
  - src/config/update-types.ts
  - src/processors/update-diff.ts
  - src/parsers/excel-parser.ts
autonomous: true
requirements: [UPD-01, UPD-03, UPD-04]

must_haves:
  truths:
    - "Diff engine correctly identifies scalar property changes between spreadsheet values and live Geo entity state"
    - "Diff engine correctly computes relation add/remove ops from desired vs. current state"
    - "Blank spreadsheet cells are skipped entirely -- never produce a diff entry or an op"
    - "The --additive flag causes relation diffs to only add, never remove"
    - "confirmAction() and resolveNetwork() are importable from a shared module by both upsert and update commands"
  artifacts:
    - path: "src/processors/update-diff.ts"
      provides: "Diff engine: scalar comparison, relation reconciliation, batch entity detail fetching"
      min_lines: 120
    - path: "src/config/update-types.ts"
      provides: "Update-specific type definitions (EntityDiff, PropertyDiff, RelationDiff, UpdateOptions)"
      min_lines: 40
    - path: "src/utils/cli-helpers.ts"
      provides: "Shared CLI helpers (confirmAction, resolveNetwork) extracted from upsert"
      min_lines: 20
  key_links:
    - from: "src/processors/update-diff.ts"
      to: "src/api/geo-client.ts"
      via: "fetchEntityDetails() for current entity state"
      pattern: "fetchEntityDetails"
    - from: "src/processors/update-diff.ts"
      to: "src/config/update-types.ts"
      via: "EntityDiff, PropertyDiff, RelationDiff types"
      pattern: "import.*update-types"
    - from: "src/commands/upsert.ts"
      to: "src/utils/cli-helpers.ts"
      via: "confirmAction, resolveNetwork imports"
      pattern: "import.*cli-helpers"
---

<objective>
Build the update infrastructure: shared CLI helpers, update-specific types, and the diff engine that computes per-entity changes by comparing spreadsheet values against live Geo entity state.

Purpose: The diff engine is the core new logic for Phase 3. Everything else (parsing, publishing, reporting) reuses existing infrastructure. This plan creates the foundation that the update command handler (Plan 02) will orchestrate.

Output: `src/processors/update-diff.ts` (diff engine), `src/config/update-types.ts` (update types), `src/utils/cli-helpers.ts` (shared helpers), updated `src/commands/upsert.ts` (uses shared helpers).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bulk-update/03-CONTEXT.md
@.planning/phases/03-bulk-update/03-RESEARCH.md
@.planning/phases/01-cli-restructure-and-shared-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-cli-restructure-and-shared-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-cli-restructure-and-shared-infrastructure/01-03-SUMMARY.md

@src/config/types.ts
@src/config/upsert-types.ts
@src/commands/upsert.ts
@src/api/geo-client.ts
@src/processors/batch-builder.ts
@src/utils/cell-parsers.ts
@src/parsers/excel-parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared CLI helpers and define update types</name>
  <files>
    src/utils/cli-helpers.ts
    src/commands/upsert.ts
    src/config/types.ts
    src/config/update-types.ts
    src/parsers/excel-parser.ts
  </files>
  <action>
    **1. Create `src/utils/cli-helpers.ts`** -- Extract `resolveNetwork()` and `confirmAction()` from `src/commands/upsert.ts` into this new shared module. Both functions move verbatim; `upsert.ts` imports them from `../utils/cli-helpers.js` instead of defining them inline.

    - `resolveNetwork(flagValue?: string): 'TESTNET' | 'MAINNET'` -- exact same logic (flag > env > default)
    - `confirmAction(message: string): Promise<boolean>` -- exact same logic (readline, TTY check, throws for non-interactive)
    - Both are named exports.

    **2. Update `src/commands/upsert.ts`** -- Remove the inline `resolveNetwork()` and `confirmAction()` functions. Add `import { resolveNetwork, confirmAction } from '../utils/cli-helpers.js';`. Verify the rest of upsert.ts is unchanged.

    **3. Add optional `operationType` to Metadata interface in `src/config/types.ts`**:
    ```typescript
    operationType?: string; // "UPSERT", "UPDATE", etc. -- from Metadata tab
    ```
    Add it after the `readyForPublishing` field. This is backward-compatible (optional field).

    **4. Update `parseMetadataTab()` in `src/parsers/excel-parser.ts`** to parse the `Operation type` field:
    - Add a case in the switch for `normalizedField === 'operationtype'` that sets `metadata.operationType = value;`
    - This is non-breaking -- existing spreadsheets without this field work fine.

    **5. Create `src/config/update-types.ts`** with update-specific types:

    ```typescript
    import type { Op } from '@geoprotocol/geo-sdk';

    /** Options for the update command */
    export interface UpdateOptions {
      network: 'TESTNET' | 'MAINNET';
      dryRun: boolean;
      verbose: boolean;
      quiet: boolean;
      yes: boolean;
      additive: boolean;
      outputDir: string;
    }

    /** Per-property scalar diff */
    export interface PropertyDiff {
      propertyId: string;
      propertyName: string;
      type: 'set' | 'unchanged';
      oldValue?: string;   // Human-readable current value
      newValue?: string;    // Human-readable new value
      typedValue?: import('@geoprotocol/geo-sdk').TypedValue; // SDK value for the op
    }

    /** Per-relation-property diff */
    export interface RelationDiff {
      propertyId: string;
      propertyName: string;
      toAdd: Array<{ entityId: string; entityName: string }>;
      toRemove: Array<{ entityId: string; entityName: string; relationId: string }>;
      unchanged: Array<{ entityId: string; entityName: string }>;
    }

    /** Per-entity diff (aggregates all property and relation changes) */
    export interface EntityDiff {
      entityId: string;
      entityName: string;
      status: 'updated' | 'skipped';  // 'skipped' when zero changes
      scalarChanges: PropertyDiff[];   // Only type='set' entries
      relationChanges: RelationDiff[]; // Only entries with toAdd or toRemove
      unchangedScalarCount: number;
      unchangedRelationCount: number;
    }

    /** Summary of all diffs across all entities */
    export interface DiffSummary {
      totalEntities: number;
      entitiesWithChanges: number;
      entitiesSkipped: number;
      totalScalarChanges: number;
      totalRelationsAdded: number;
      totalRelationsRemoved: number;
    }
    ```
  </action>
  <verify>
    <automated>cd /root/geo-learnings/spreadsheet-to-geo && npx tsx src/cli.ts upsert --help 2>&1 | head -5</automated>
    <manual>Verify upsert --help still shows the expected output (shared helpers didn't break the import chain)</manual>
  </verify>
  <done>
    - `src/utils/cli-helpers.ts` exists with `confirmAction()` and `resolveNetwork()` as named exports
    - `src/commands/upsert.ts` imports from `../utils/cli-helpers.js` instead of defining inline
    - `src/config/types.ts` has optional `operationType` on Metadata
    - `src/parsers/excel-parser.ts` parseMetadataTab parses `Operation type` field
    - `src/config/update-types.ts` exports UpdateOptions, PropertyDiff, RelationDiff, EntityDiff, DiffSummary
    - `npx tsx src/cli.ts upsert --help` still works (no regression)
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the diff engine</name>
  <files>
    src/processors/update-diff.ts
  </files>
  <action>
    Create `src/processors/update-diff.ts` -- the diff engine that compares spreadsheet values against live Geo entity state and produces typed diffs.

    **Imports:**
    - `fetchEntityDetails` and `EntityDetails` from `../api/geo-client.js`
    - `normalizeEntityName`, `parseDate`, `parseDatetime`, `parseTime` from `../utils/cell-parsers.js`
    - `PropertyDiff`, `RelationDiff`, `EntityDiff`, `DiffSummary` from `../config/update-types.js`
    - `PropertyDefinition` from `../config/upsert-types.js`
    - `logger` from `../utils/logger.js`

    **Core exports:**

    1. `async function computeEntityDiffs(entities, resolvedEntities, propertyDefs, spaceId, network, options): Promise<{ diffs: EntityDiff[], summary: DiffSummary }>`
       - `entities`: Array of `{ name, properties, relations }` from the parsed spreadsheet (SpreadsheetEntity[])
       - `resolvedEntities`: Map of normalized name -> `{ id, name }` (resolved entity IDs from searchEntitiesByNames)
       - `propertyDefs`: Map of normalized property name -> `{ id, dataType, ... }` (resolved properties from entityMap)
       - `spaceId`: string
       - `network`: 'TESTNET' | 'MAINNET'
       - `options`: `{ additive: boolean, verbose: boolean }`

       Implementation:
       - Batch-fetch entity details using `fetchEntityDetails()` with concurrency of 10 (same pattern as `fetchExistingRelations` in geo-client.ts). If any entity's details cannot be fetched, hard-error (do NOT proceed with partial data).
       - For each entity, call `diffEntity()` to compute per-entity diff.
       - Aggregate into DiffSummary.
       - Return `{ diffs, summary }`.

    2. `function diffEntity(entity, details, propertyDefs, resolvedEntities, options): EntityDiff`
       - For each non-blank scalar property in the spreadsheet entity:
         - Find the property's resolved ID from propertyDefs
         - Skip if property dataType is RELATION (handled separately)
         - Skip if cell value is blank/empty (this is the UPD-04 override: blank = skip, not unset)
         - Call `diffScalarProperty()` to compare
       - For each non-blank relation property in the spreadsheet entity:
         - Call `diffRelationProperty()` to compute add/remove sets
       - Set status to 'updated' if any scalarChanges or relationChanges have changes, 'skipped' otherwise.

    3. `function diffScalarProperty(propertyName, propertyId, spreadsheetValue, currentValues, dataType): PropertyDiff`
       - Find current value for this property from `currentValues` (EntityDetails.values) by matching `propertyId`.
       - Normalize BOTH spreadsheet value and current API value to canonical form before comparison:
         - TEXT: direct string comparison (trim both)
         - DATE: parse both through `parseDate()` and compare YYYY-MM-DD strings
         - DATETIME: parse both through `parseDatetime()` and compare
         - TIME: parse both through `parseTime()` and compare
         - BOOLEAN: normalize both to boolean and compare
         - INTEGER: parseInt both and compare
         - FLOAT: parseFloat both and compare (use small epsilon for floating point)
         - POINT: compare as "lat,lon" strings
       - Return `{ type: 'unchanged' }` if equal, `{ type: 'set', oldValue, newValue, typedValue }` if different.
       - `typedValue` uses the same `convertToTypedValue()` logic from batch-builder.ts. Rather than importing a private function, re-implement the same switch (or extract it -- Claude's discretion).
       - `oldValue` and `newValue` are human-readable string representations for display.

    4. `function diffRelationProperty(propertyId, propertyName, desiredTargetIds, currentRelations, resolvedEntities, additive): RelationDiff`
       - Filter `currentRelations` (EntityDetails.relations) to those with `typeId === propertyId`.
       - Build current target ID set from filtered relations.
       - Build desired target ID set from `desiredTargetIds` (already resolved to entity IDs by the caller).
       - Compute `toAdd`: desired IDs not in current set (with entity name lookup from resolvedEntities).
       - Compute `toRemove`: If `additive` is true, toRemove is empty. Otherwise, current relations not in desired set (include the relation's own ID for deleteRelation()).
       - Compute `unchanged`: IDs in both sets.

    5. `function computeDiffSummary(diffs: EntityDiff[]): DiffSummary`
       - Aggregate counts across all entity diffs.

    **Critical notes from research to encode in comments:**
    - Relation property ID IS the relation type ID (relation.typeId === resolvedProperty.id). Document this clearly.
    - When comparing values, always compare in canonical form, not raw strings. The Geo API returns dates as ISO datetime, booleans as true/false, etc.
    - Empty cells MUST be checked first before any comparison (blank = skip regardless of --additive).
    - Hard-error if any fetchEntityDetails call returns null (entity exists but details can't be fetched = API failure, not "entity doesn't exist").

    **Helper for extracting current value from EntityDetails:**
    ```typescript
    function getCurrentValueAsString(values: EntityDetails['values'], propertyId: string, dataType: string): string | null {
      const match = values.find(v => v.propertyId === propertyId);
      if (!match) return null;
      // Return the appropriate field based on dataType
      switch (dataType) {
        case 'TEXT': return match.text;
        case 'BOOLEAN': return match.boolean !== null ? String(match.boolean) : null;
        case 'INTEGER':
        case 'FLOAT': return match.float !== null ? String(match.float) : null;
        case 'DATE':
        case 'DATETIME': return match.datetime;
        case 'TIME': return match.datetime; // Time stored as datetime in API
        case 'POINT': return match.point;
        default: return match.text;
      }
    }
    ```
  </action>
  <verify>
    <automated>cd /root/geo-learnings/spreadsheet-to-geo && npx tsx -e "import { computeEntityDiffs } from './src/processors/update-diff.js'; console.log('update-diff.ts loads OK')" 2>&1</automated>
    <manual>Verify the module imports and exports resolve correctly</manual>
  </verify>
  <done>
    - `src/processors/update-diff.ts` exports `computeEntityDiffs`, `diffEntity`, `diffScalarProperty`, `diffRelationProperty`, `computeDiffSummary`
    - Scalar property comparison normalizes both sides before comparing (no false diffs from format differences)
    - Blank cells produce no diff entry (skip logic present)
    - --additive mode produces no toRemove entries in relation diffs
    - Hard-error on null fetchEntityDetails response (API failure)
    - Batch fetching with concurrency of 10
  </done>
</task>

</tasks>

<verification>
- `npx tsx src/cli.ts upsert --help` produces expected output (shared helpers extraction didn't break upsert)
- `src/processors/update-diff.ts` compiles and its exports are importable
- `src/config/update-types.ts` compiles and its types are importable
- `src/utils/cli-helpers.ts` exports confirmAction and resolveNetwork
</verification>

<success_criteria>
- Diff engine can compute per-entity scalar and relation diffs given spreadsheet data and live entity state
- All update-specific types are defined and exported
- Shared CLI helpers extracted without breaking upsert command
- Blank cell skip logic is implemented in the diff engine
- Additive mode flag is respected in relation diffs
</success_criteria>

<output>
After completion, create `.planning/phases/03-bulk-update/03-01-SUMMARY.md`
</output>
